var participants = {};

var horsesGame = (hashFunction, data) => {
    const HORSE_SVG_PATH = "m149.963994,26.671797l-2.61302,-2.497528l-2.252106,-2.555274c0,0 0,-1.212672 -1.039433,-0.967251c0,0 -3.522524,-5.716884 -7.174978,-7.665822c0,0 0.303168,-1.588023 -1.400348,-1.09718c0,0 -3.002808,-2.295416 -4.244353,-1.847882c0,0 -3.594707,-2.353162 -3.854566,-3.002808c0,0 -0.072183,2.021121 1.169363,3.392595c0,0 -2.540837,0.519717 -2.742949,1.241546c0,0 -4.244353,2.093303 -4.504212,4.316536c0,0 0.129929,0.5919 -3.334849,1.761262c0,0 -2.353162,0.332041 -2.945061,1.443658c0,0 -1.371475,0.332041 -1.761262,0.721829c0,0 -1.703516,-0.779575 -3.652454,0.259858l-1.631333,1.039433c0,0 -1.443658,-0.981687 -1.833445,-0.981687c0,0 0.259858,-2.872879 0,-3.20492c0,0 0.129929,-2.280979 0,-2.61302c0,0 1.227109,-0.938377 2.872879,-0.288732c0,0 0.259858,1.198236 1.169363,0.721829c0,0 0.707392,-0.375351 0.750702,-0.721829c0,0 0.635209,0 0.519717,-0.563026c0,0 0.635209,-0.115493 0.635209,-0.447534c0,0 0.187675,-0.490844 0.303168,-0.447534c0,0 0.794012,0.303168 1.616896,-0.678519c0,0 1.472531,-1.616896 0.750702,-2.06443l0.115493,-0.490844c0,0 1.385911,0.115493 1.920065,-0.447534c0,0 0.259858,-0.375351 -1.385911,-0.303168c0,0 0.563026,-5.947869 -4.663014,-6.467586c0,0 -1.616896,0 -2.06443,0.144366c0,0 -0.822885,-0.144366 -1.241546,0.447534c0,0 -1.429221,1.169363 -1.876755,2.410908c0,0 -0.750702,0.072183 -0.447534,0.563026c0,0 -3.103864,-0.216549 -4.460902,0.230985c0,0 -5.240477,-1.01056 -8.026736,-0.245422c0,0 -8.43096,1.255982 -8.93624,4.446465c0,0 -1.111616,1.212672 -2.122177,1.819009c0,0 -3.233793,1.588023 -2.829569,4.995055c0,0 0.245422,3.681327 4.143297,4.893999c0,0 5.803503,2.872879 9.831308,3.176047l-0.245422,0.404224c0,0 -4.893999,-0.447534 -7.723568,1.357038c0,0 -7.521456,-2.266542 -10.235532,-1.111616c0,0 -6.453149,0.274295 -10.163349,-0.216549c0,0 -4.865126,-1.212672 -10.466517,2.19436c0,0 -7.608075,4.071114 -7.96899,4.749633c0,0 -1.400348,0.909504 -2.800696,0.909504c0,0 -2.252106,-0.303168 -7.665822,2.122177c0,0 -3.407032,1.342602 -4.80738,0.851758c0,0 1.039433,0.664082 1.948938,0.54859c0,0 -3.103864,1.09718 -6.626388,-0.851758c0,0 -1.64577,-0.794012 -3.16161,-0.245422c0,0 1.920065,0.245422 2.714076,1.400348c0,0 0.736265,0.967251 1.588023,1.270419c0,0 -4.792943,1.039433 -9.167226,-0.664082c0,0 1.51584,1.588023 4.922872,1.64577c0,0 -0.851758,1.039433 -5.716884,0.736265c0,0 -2.800696,-0.54859 -5.370406,3.435905c0,0 2.872879,-3.017244 5.240477,-2.887315c0,0 2.800696,0.360914 3.219356,0.303168c0,0 -2.093303,0.981687 -4.316536,0.967251c0,0 -2.252106,0 -6.149981,4.677451c0,0 -1.51584,1.819009 -4.504212,2.367598c0,0 2.742949,0.360914 6.684135,-3.349286c0,0 1.51584,-1.400348 3.16161,-1.400348c0,0 -6.453149,5.659138 -10.711939,5.601391c0,0 2.742949,1.09718 11.491514,-4.25879c0,0 1.212672,-1.039433 5.471462,-0.490844c0,0 4.201044,1.039433 7.362654,-0.245422c0,0 -1.342602,1.212672 -3.652454,1.212672c0,0 8.93624,0.54859 11.982358,-3.825693c0,0 0.303168,2.670767 3.825693,3.16161c0,0 -3.16161,-0.606336 -1.819009,-4.25879c0,0 0.54859,4.071114 4.749633,4.619704c0,0 -4.013368,-0.967251 -1.891191,-6.077798c0,0 2.252106,-3.103864 2.61302,-4.25879c0,0 1.270419,-0.418661 1.154926,0.54859c0,0 -1.588023,8.93624 0.851758,11.1306c0,0 6.149981,6.510896 10.827432,7.117232c0,0 1.819009,2.006684 -0.909504,6.380966l-2.006684,2.61302c0,0 -2.670767,3.16161 1.400348,4.749633l3.103864,1.212672c0,0 6.814064,3.407032 7.232724,3.522524c0,0 2.309852,1.819009 2.555274,2.555274c0,0 1.09718,1.588023 1.948938,2.19436l-0.187675,0.736265c0,0 -0.794012,0.303168 -1.039433,0.664082c0,0 0.360914,4.446465 1.761262,5.659138c0,0 2.742949,-2.19436 2.497528,-4.128861c0,0 -0.303168,-3.7102 -0.418661,-3.955622c-0.115493,-0.245422 0.245422,-2.800696 -1.588023,-3.594707l-9.123916,-6.380966c0,0 -1.761262,-0.794012 -0.303168,-3.594707l3.825693,-4.980619c0,0 1.51584,5.716884 1.154926,9.181662c0,0 -0.245422,2.742949 1.819009,3.291539c0,0 11.563697,6.814064 13.570381,9.311591c0,0 1.588023,1.819009 2.670767,1.154926l1.51584,1.212672l-0.606336,1.588023c0,0 3.407032,2.916188 5.832377,2.309852c0,0 -0.187675,-1.588023 -1.09718,-3.594707l-3.652454,-3.407032c0,0 -1.09718,-1.891191 -2.742949,-2.670767c0,0 -9.427084,-6.380966 -10.394335,-7.911244c0,0 -1.09718,-2.555274 -0.115493,-7.535893c0,0 0.54859,-3.767946 -0.245422,-7.96899c-0.346478,-1.862318 3.897875,3.825693 12.068977,4.359846l6.178854,1.847882c0,0 0.418661,0.794012 2.19436,2.858442c0,0 4.865126,11.318275 6.929556,12.09785c0,0 0.187675,1.039433 -1.948938,1.09718l-6.077798,-0.54859c0,0 -1.948938,-1.270419 -4.25879,-1.09718c0,0 -0.736265,-0.245422 -1.154926,-0.794012c0,0 0,-1.761262 -1.212672,-2.439781c0,0 -1.154926,-1.154926 -4.316536,0.245422c0,0 -2.122177,1.09718 -0.490844,1.761262l2.497528,2.006684c0,0 1.819009,1.039433 2.742949,1.212672l1.212672,0.967251c0,0 1.588023,1.64577 4.143297,1.212672l8.156665,0.490844c0,0 2.61302,-0.057746 4.071114,-1.64577c0,0 1.212672,-1.819009 0.664082,-3.349286l-1.039433,-2.973935c0,0 -1.212672,-8.459833 -1.588023,-9.123916c0,0 3.16161,-0.54859 3.955622,-0.967251c0,0 2.670767,0.418661 3.464778,0.245422c0,0 0.360914,1.400348 10.03342,2.61302c0,0 1.819009,0.418661 2.252106,2.309852l-0.115493,1.64577c0,0 -1.64577,4.561958 -2.742949,6.265474c0,0 -1.703516,1.761262 -1.154926,3.522524l-0.736265,1.703516c0,0 -0.794012,0.54859 -0.794012,0.967251l-1.819009,0.909504c0,0 -0.851758,3.897875 0.303168,4.980619c0,0 3.046117,-1.948938 3.16161,-2.742949l1.342602,-2.61302c0,0 0.909504,-2.252106 1.270419,-2.367598c0,0 0.851758,-0.909504 1.212672,-2.742949c0,0 2.439781,-5.716884 2.800696,-7.117232c0,0 1.588023,-2.19436 0.909504,-4.143297c0,0 -0.490844,-2.19436 -1.819009,-2.916188l-3.407032,-2.252106l-4.980619,-3.767946c0,0 1.400348,-1.588023 1.64577,-3.825693c0,0 3.103864,-5.22604 3.407032,-9.672506c0,0 4.836253,-8.878494 5.688011,-10.58201c0,0 1.111616,-2.353162 3.305976,-3.176047l0,0.187675c0,0.115493 0.173239,0.216549 0.360914,0.216549c0.202112,0 0.360914,-0.101056 0.360914,-0.216549l0,-0.389788c0.433097,-0.086619 0.938377,-0.101056 1.443658,-0.028873c0,0 5.067238,1.703516 5.86125,2.06443c0,0 0.490844,1.51584 2.439781,0.909504c0,0 1.458094,0.54859 1.64577,0.54859s0.346478,0.909504 1.891191,1.039433c0,0 0.360914,2.309852 3.349286,0.909504c0,0 0.433097,-0.187675 0.360914,-0.851758c0,0 1.09718,1.588023 2.06443,-0.187675l0.303168,-1.64577c0.101056,0.04331 2.10774,-1.660206 0.101056,-3.24823zm-50.398086,-0.606336c2.555274,-2.800696 -3.508088,-6.32322 -3.508088,-6.32322l0,-0.245422l1.862318,-0.736265c0.245422,0.794012 3.291539,6.698571 3.291539,6.698571l-1.64577,0.606336z";
    const NEUTRAL_X_OFFSET = 100;
    const NEUTRAL_Y_OFFSET = 50;
    const RACE_LENGTH = 600;
    const LANE_SEPARATION = 50;
    const HORSE_WIDTH = 147;
    const FINISH_LINE_X_ADJUSTMENT = -20;
    const TEXT_X_OFFSET = 10;
    const TEXT_Y_OFFSET = 100;

    const availableColours = [
        "#663C7F",
        "#7F663C",
        "#3C7F66",
        "#3C557F",
        "#7F3C55"
    ];

    const STEP_SIZE = RACE_LENGTH / (data.maxSteps);
    const MS_PER_STEP = data.msPerStep;

    // Clear canvas
    var s = Snap("#game-div");
    s.clear();

    // Draw finishing post
    let finishX = NEUTRAL_X_OFFSET + RACE_LENGTH + HORSE_WIDTH + FINISH_LINE_X_ADJUSTMENT;
    s.rect(finishX, 100, 1,(LANE_SEPARATION * data.participants.length) + 10).attr({ // Finish line
        "stroke":"#000000",
        "stroke-width":1
    });

    s.rect(finishX - 4, 25, 9, 75).attr({ // Post upright
        "fill":"#FFFFFF",
        "stroke":"#000000",
        "stroke-width":3
    });

    s.circle(finishX, 25, 15).attr({ // Post top
        "fill":"#FFFFFF",
        "stroke":"#FF0000",
        "stroke-width":10
    })

    // Set up colour set
    let colours = availableColours.slice();

    for (let i = 0; i < data.participants.length; i++) {
        const playerName = data.participants[i];

        let colour = colours[hashFunction(playerName) % colours.length];

        // Draw player's name
        s.text(TEXT_X_OFFSET, TEXT_Y_OFFSET + (i * LANE_SEPARATION), playerName).attr({
            "font-size":30, 
            "font-family":"Roboto, sans-serif", 
            "font-weight":"bold",
            "fill":colour,
            "stroke":"#000000",
            "stroke-width":0
        })

        let initialTransform = `t${NEUTRAL_X_OFFSET},${NEUTRAL_Y_OFFSET + (i * LANE_SEPARATION)}`;
        let x = s.path(HORSE_SVG_PATH)
            .attr({
                "fill": colour,
                "stroke": "#000000"
            })
            .transform(initialTransform);

        participants[playerName] = { horse: x, steps: 0 };
        //console.log(participants[playerName].horse.transform());

        // Remove previous colour
        let colourIndex = colours.indexOf(colour);
        colours.splice(colourIndex, 1);
        if (colours.length === 0) {
            // Rebuild colour list
            colours = availableColours.slice();
            
            // Remove last colour chosen
            colourIndex = colours.indexOf(colour);
            colours.splice(colourIndex, 1);
        }
    }

    let gameStart = (data) => {
        console.log(data);
    }

    let gameUpdate = (data) => {
        console.log(data);

        let moveDist = STEP_SIZE * data.updateSteps;
        console.log(moveDist);

        participants[data.player].horse.animate({ "transform": `...t${moveDist},0` }, MS_PER_STEP, mina.easeinout, () => {
            participants[data.player].steps += data.updateSteps;
            console.log(`${data.player} reached ${participants[data.player].steps}`);
            
            // If this horse has stopped, check all the others to see if only 1 is left
            if (participants[data.player].steps === 20) {
                // Get list of horses that haven't finished
                let unfinished = [];
                for (const player in participants) {
                    if (participants.hasOwnProperty(player)) {
                        if (participants[player].steps !== 20) {
                            unfinished.push(player);
                        }
                    }
                }
                if (unfinished.length === 1) {
                    participants[unfinished[0]].horse.stop();
                    alert(unfinished[0]);
                }
            }
        });
        console.log(participants[data.player].horse.transform())
    }

    return {
        gameStart: gameStart,
        gameUpdate: gameUpdate
    };
}